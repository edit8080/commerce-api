## 선착순 쿠폰 발급

### 쿠폰 발급의 정확성

- 선착순 발급의 정확성을 위해 낙관적 락 대신 **DB 비관적 락**을 선택
- 비관적 락을 설정하기 용이한 구조를 위해 COUPON_TICKET 테이블 분리 
- 선착순 쿠폰 발급을 위한 티켓 사전 생성 및 동시성 제어
    - 총 수량(`total_quantity`) 과 발급 수량(`issued_quantity`)을 하나의 Coupon 테이블로 관리할 경우 동시성 이슈 발생
      → 발급 수량 컬럼을 관리하기 위해 1,000명의 사용자가 하나의 레코드를 수정하기 위해 대기하는 상황 발생


```kotlin
fun 쿠폰발급(){
  // 1. 쿠폰 정보 조회
  // 2. 유효성 검사 (유효 기간, 잔여 수량)
  // 3. 발급 수량 증가 (issued_quantity = issued_quantity + 1) <-- 부하 고려
  // 4. 사용자 쿠폰 발급
}
```

### 쿠폰 발급의 신속성
- 이 문제를 해결하기 위해 관리자가 발급 수량만큼의 티켓 엔티티(1,000개)를 미리 생성
    - UPDATE 중인 것을 건너뛰고 다음 엔티티 접근 → `FOR UPDATE SKIP LOCKED` 활용
    - 하나의 엔티티가 아닌 여러 엔티티를 선점함으로써 쿠폰을 신속하게 발급

### 유효성 검사
- 체크 항목
    - 발급 유효 기간 체크
    - 잔여 수량 체크

### 중복 발급 방지
- `USER_COUPON` 에 `(user_id, coupon_id)` 복합 속성 기반 UNIQUE 제약 조건 적용
```sql
  CREATE UNIQUE INDEX idx_user_coupon_unique
  ON USER_COUPON(user_id, coupon_id);
```

### 추가 고려
- 발급되거나 만료된 티켓은 배치로 정리하거나 별도의 이력 테이블로 관리
- 현 시점(v1.0) 에서 기능 구현을 고려하지 않음
